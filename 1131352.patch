# HG changeset patch
# Parent 808863cff38de00a4c6673c29ba86312b8195921
# User Jose Antonio Olivera Ortega <josea.olivera@gmail.com>
Bug 1131352 - Add ServiceWorkerGlobalScope skipWaiting(). r=nsm

diff --git a/dom/webidl/ServiceWorkerGlobalScope.webidl b/dom/webidl/ServiceWorkerGlobalScope.webidl
--- a/dom/webidl/ServiceWorkerGlobalScope.webidl
+++ b/dom/webidl/ServiceWorkerGlobalScope.webidl
@@ -15,16 +15,19 @@
 interface ServiceWorkerGlobalScope : WorkerGlobalScope {
   readonly attribute Clients clients;
 
   void update();
 
   [Throws]
   Promise<boolean> unregister();
 
+  [Throws]
+  Promise<boolean> skipWaiting();
+
   attribute EventHandler oninstall;
   attribute EventHandler onactivate;
   attribute EventHandler onfetch;
   attribute EventHandler onbeforeevicted;
   attribute EventHandler onevicted;
 
   // The event.source of these MessageEvents are instances of Client
   attribute EventHandler onmessage;
diff --git a/dom/workers/WorkerScope.cpp b/dom/workers/WorkerScope.cpp
--- a/dom/workers/WorkerScope.cpp
+++ b/dom/workers/WorkerScope.cpp
@@ -968,16 +968,44 @@ ServiceWorkerGlobalScope::Unregister(Err
   // soon anyway.
   if (runnable->WorkerPromise()) {
     NS_DispatchToMainThread(runnable);
   }
 
   return promise.forget();
 }
 
+class WorkerScopeSkipWaitingRunnable final : public nsRunnable
+{
+public:
+  NS_IMETHODIMP
+  Run() override
+  {
+    AssertIsOnMainThread();
+
+    return NS_OK;
+  }
+};
+
+already_AddRefed<Promise>
+ServiceWorkerGlobalScope::SkipWaiting(ErrorResult& aRv)
+{
+  mWorkerPrivate->AssertIsOnWorkerThread();
+  MOZ_ASSERT(mWorkerPrivate->IsServiceWorker());
+
+  nsRefPtr<Promise> promise = Promise::Create(this, aRv);
+  if (aRv.Failed()) {
+    return nullptr;
+  }
+
+  // Figure out how to skip waiting here.
+
+  return promise.forget();
+}
+
 namespace {
 
 class UpdateRunnable final : public nsRunnable
 {
   nsString mScope;
 
 public:
   explicit UpdateRunnable(const nsAString& aScope)
diff --git a/dom/workers/WorkerScope.h b/dom/workers/WorkerScope.h
--- a/dom/workers/WorkerScope.h
+++ b/dom/workers/WorkerScope.h
@@ -219,16 +219,19 @@ public:
   }
 
   void
   Update();
 
   already_AddRefed<Promise>
   Unregister(ErrorResult& aRv);
 
+  already_AddRefed<Promise>
+  SkipWaiting(ErrorResult& aRv);
+
   ServiceWorkerClients*
   Clients();
 
   IMPL_EVENT_HANDLER(activate)
   IMPL_EVENT_HANDLER(beforeevicted)
   IMPL_EVENT_HANDLER(evicted)
   IMPL_EVENT_HANDLER(fetch)
   IMPL_EVENT_HANDLER(install)
