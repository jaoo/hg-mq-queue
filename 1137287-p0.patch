# HG changeset patch
# User Nikhil Marathe <nsm.nikhil@gmail.com>
# Date 1424969631 18000
#      Thu Feb 26 11:53:51 2015 -0500
# Node ID 0e31c3dc20dfcbe38569b486b23263e7d5e5d58e
# Parent a35163f83d22a34de0d34bda0f656b1ce57b9c41
Bug 1137287 - Part 0: Test for synthesized redirects.

diff --git a/dom/workers/test/serviceworkers/fetch/fetch_tests.js b/dom/workers/test/serviceworkers/fetch/fetch_tests.js
--- a/dom/workers/test/serviceworkers/fetch/fetch_tests.js
+++ b/dom/workers/test/serviceworkers/fetch/fetch_tests.js
@@ -41,16 +41,29 @@ fetchXHR('synthesized-404.txt', function
 
 fetchXHR('synthesized-headers.txt', function(xhr) {
   my_ok(xhr.status == 200, "load should be successful");
   my_ok(xhr.getResponseHeader("X-Custom-Greeting") === "Hello", "custom header should be set");
   my_ok(xhr.responseText == "synthesized response body", "custom header load should have synthesized response");
   finish();
 });
 
+fetch('synthesized-redirect-real-file.txt', function(xhr) {
+dump("Got status AARRGH " + xhr.status + " " + xhr.responseText + "\n");
+  my_ok(xhr.status == 200, "load should be successful");
+  my_ok(xhr.responseText == "This is a real file.\n", "Redirect to real file should complete.");
+  finish();
+});
+
+fetch('synthesized-redirect-synthesized.txt', function(xhr) {
+  my_ok(xhr.status == 200, "load should be successful");
+  my_ok(xhr.responseText == "synthesized response body", "load should have synthesized response");
+  finish();
+});
+
 fetchXHR('ignored.txt', function(xhr) {
   my_ok(xhr.status == 404, "load should be uninterrupted");
   finish();
 });
 
 fetchXHR('rejected.txt', null, function(xhr) {
   my_ok(xhr.status == 0, "load should not complete");
   finish();
diff --git a/dom/workers/test/serviceworkers/fetch/real-file.txt b/dom/workers/test/serviceworkers/fetch/real-file.txt
new file mode 100644
--- /dev/null
+++ b/dom/workers/test/serviceworkers/fetch/real-file.txt
@@ -0,0 +1,1 @@
+This is a real file.
diff --git a/dom/workers/test/serviceworkers/fetch_event_worker.js b/dom/workers/test/serviceworkers/fetch_event_worker.js
--- a/dom/workers/test/serviceworkers/fetch_event_worker.js
+++ b/dom/workers/test/serviceworkers/fetch_event_worker.js
@@ -22,16 +22,28 @@ onfetch = function(ev) {
       })
     ));
   }
 
   else if (ev.request.url.contains("test-respondwith-response.txt")) {
     ev.respondWith(new Response("test-respondwith-response response body", {}));
   }
 
+  else if (ev.request.url.contains("synthesized-redirect-real-file.txt")) {
+    ev.respondWith(Promise.resolve(
+      Response.redirect("fetch/real-file.txt")
+    ));
+  }
+
+  else if (ev.request.url.contains("synthesized-redirect-synthesized.txt")) {
+    ev.respondWith(Promise.resolve(
+      Response.redirect("synthesized.txt")
+    ));
+  }
+
   else if (ev.request.url.contains("ignored.txt")) {
   }
 
   else if (ev.request.url.contains("rejected.txt")) {
     ev.respondWith(Promise.reject());
   }
 
   else if (ev.request.url.contains("nonresponse.txt")) {
diff --git a/dom/workers/test/serviceworkers/mochitest.ini b/dom/workers/test/serviceworkers/mochitest.ini
--- a/dom/workers/test/serviceworkers/mochitest.ini
+++ b/dom/workers/test/serviceworkers/mochitest.ini
@@ -22,16 +22,17 @@ support-files =
   match_all_advanced_worker.js
   worker_unregister.js
   worker_update.js
   message_posting_worker.js
   fetch/index.html
   fetch/fetch_worker_script.js
   fetch/fetch_tests.js
   fetch/deliver-gzip.sjs
+  fetch/real-file.txt
   fetch/context/index.html
   fetch/context/register.html
   fetch/context/unregister.html
   fetch/context/context_test.js
   fetch/context/realimg.jpg
   fetch/context/realaudio.ogg
   fetch/context/beacon.sjs
   fetch/context/csp-violate.sjs
