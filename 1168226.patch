# HG changeset patch
# User Jose Antonio Olivera Ortega <jaoo@jaoo.es>
# Parent  490156f7447e7a6e4cf0ba0b980267ab2a7767ff
Bug 1168226 - ServiceWorkerRegistrar only use the scope when registering a service worker. r=baku

diff --git a/dom/workers/ServiceWorkerRegistrar.cpp b/dom/workers/ServiceWorkerRegistrar.cpp
--- a/dom/workers/ServiceWorkerRegistrar.cpp
+++ b/dom/workers/ServiceWorkerRegistrar.cpp
@@ -144,22 +144,37 @@ ServiceWorkerRegistrar::RegisterServiceW
     NS_WARNING("Failed to register a serviceWorker during shutting down.");
     return;
   }
 
   {
     MonitorAutoLock lock(mMonitor);
     MOZ_ASSERT(mDataLoaded);
 
+    const mozilla::ipc::PrincipalInfo& newPrincipalInfo = aData.principal();
+
     bool found = false;
     for (uint32_t i = 0, len = mData.Length(); i < len; ++i) {
       if (mData[i].scope() == aData.scope()) {
-        mData[i] = aData;
-        found = true;
-        break;
+        const mozilla::ipc::PrincipalInfo& existingPrincipalInfo =
+          mData[i].principal();
+
+        MOZ_ASSERT(newPrincipalInfo.type() ==
+                   mozilla::ipc::PrincipalInfo::TContentPrincipalInfo);
+
+        const mozilla::ipc::ContentPrincipalInfo& newContentPrincipalInfo =
+          newPrincipalInfo.get_ContentPrincipalInfo();
+        const mozilla::ipc::ContentPrincipalInfo& existingContentPrincipalInfo =
+          existingPrincipalInfo.get_ContentPrincipalInfo();
+
+        if (newContentPrincipalInfo == existingContentPrincipalInfo) {
+          mData[i] = aData;
+          found = true;
+          break;
+        }
       }
     }
 
     if (!found) {
       mData.AppendElement(aData);
     }
   }
 
